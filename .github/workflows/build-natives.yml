# Build native libdave-jvm and natives JAR per target. Each job runs in parallel.
# Requires: cmake build in natives/cmake-build-<target>/ then Gradle :natives:build -Ptarget=<target>
name: Build natives

on:
  push:
    branches: [ '**' ]
    paths-ignore:
      - '**.md'
  release:
    types: [ published ]
  workflow_dispatch:

env:
  JAVA_VERSION: "21"

jobs:
  build:
    name: ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 22.04 - glibc
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            toolchain: natives/cmake/toolchains/linux-x86_64-gnu.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: ""
          - os: ubuntu-22.04
            target: i686-unknown-linux-gnu
            toolchain: natives/cmake/toolchains/linux-i686-gnu.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/x86-i686/tarballs/x86-i686--glibc--stable-2024.05-1.tar.xz"
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            toolchain: natives/cmake/toolchains/linux-aarch64-gnu.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--glibc--stable-2024.05-1.tar.xz"
          - os: ubuntu-22.04
            target: arm-unknown-linux-gnueabihf
            toolchain: natives/cmake/toolchains/linux-armhf-gnu.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/armv7-eabihf/tarballs/armv7-eabihf--glibc--stable-2024.05-1.tar.xz"
          # Ubuntu 22.04 - musl
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            toolchain: natives/cmake/toolchains/linux-x86_64-musl.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/x86-64/tarballs/x86-64--musl--stable-2024.05-1.tar.xz"
          - os: ubuntu-22.04
            target: i686-unknown-linux-musl
            toolchain: natives/cmake/toolchains/linux-i686-musl.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/x86-i686/tarballs/x86-i686--musl--stable-2024.05-1.tar.xz"
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            toolchain: natives/cmake/toolchains/linux-aarch64-musl.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/aarch64/tarballs/aarch64--musl--stable-2024.05-1.tar.xz"
          - os: ubuntu-22.04
            target: arm-unknown-linux-musleabihf
            toolchain: natives/cmake/toolchains/linux-armhf-musl.cmake
            linux_packages: "build-essential cmake ninja-build"
            bootlin_url: "https://toolchains.bootlin.com/downloads/releases/toolchains/armv7-eabihf/tarballs/armv7-eabihf--musl--stable-2024.05-1.tar.xz"
          # Windows MSVC 2022
          - os: windows-2022
            target: x86_64-pc-windows-msvc
            cmake_arch: x64
          - os: windows-2022
            target: i686-pc-windows-msvc
            cmake_arch: Win32
          - os: windows-2022
            target: aarch64-pc-windows-msvc
            cmake_arch: ARM64
          # macOS Xcode 15
          - os: macos-14
            target: x86_64-apple-darwin
            osx_arch: x86_64
          - os: macos-14
            target: aarch64-apple-darwin
            osx_arch: arm64
          - os: macos-14
            target: aarch64e-apple-darwin
            osx_arch: arm64e

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Install Linux build deps
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.linux_packages }}

      - name: Install Bootlin toolchain
        if: matrix.os == 'ubuntu-22.04' && matrix.bootlin_url != ''
        run: |
          sudo mkdir -p /opt/toolchains
          archive="$(basename "${{ matrix.bootlin_url }}")"
          toolchain_dir="/opt/toolchains/${archive%.tar.xz}"

          if [ ! -d "$toolchain_dir" ]; then
            curl -sSL "${{ matrix.bootlin_url }}" | sudo tar -xJ -C /opt/toolchains
            cd "$toolchain_dir"
            sudo ./relocate-sdk.sh
          fi

      - name: Configure CMake (Linux)
        if: matrix.os == 'ubuntu-22.04'
        working-directory: ${{ github.workspace }}
        run: |
          cmake -S natives -B natives/cmake-build-${{ matrix.target }} \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/${{ matrix.toolchain }}

      - name: Configure CMake (Windows)
        if: matrix.os == 'windows-2022'
        working-directory: ${{ github.workspace }}
        run: |
          cmake -S natives -B natives/cmake-build-${{ matrix.target }} -G "Visual Studio 17 2022" -A ${{ matrix.cmake_arch }} -T ClangCL -DCMAKE_BUILD_TYPE=Release -DOPENSSL_NO_ASM=ON

      - name: Configure CMake (macOS)
        if: matrix.os == 'macos-14'
        working-directory: ${{ github.workspace }}
        env:
          CMAKE_OSX_ARCHITECTURES: ${{ matrix.osx_arch }}
        run: |
          cmake -S natives -B natives/cmake-build-${{ matrix.target }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.osx_arch }}

      - name: Build CMake (Linux/macOS)
        if: matrix.os != 'windows-2022'
        working-directory: ${{ github.workspace }}
        run: |
          cmake --build natives/cmake-build-${{ matrix.target }} --config Release

      - name: Build CMake (Windows)
        if: matrix.os == 'windows-2022'
        working-directory: ${{ github.workspace }}
        run: |
          cmake --build natives/cmake-build-${{ matrix.target }} --config Release
          # Place DLL and PDB at build root for Gradle (VS generator may put them in Release/)
          $b = "natives/cmake-build-${{ matrix.target }}"
          $r = "$b/Release"
          if (Test-Path "$r/dave-jvm.dll") { Copy-Item "$r/dave-jvm.dll" $b }
          if (Test-Path "$r/*.pdb") { Copy-Item "$r/*.pdb" $b }

      - name: Build natives JAR (Unix)
        if: matrix.os != 'windows-2022'
        run: |
          ./gradlew :natives:build :natives:publish \
          --no-daemon \
          -Ptarget=${{ matrix.target }} \
          -PMAVEN_USERNAME=${{ secrets.MAVEN_USERNAME }} \
          -PMAVEN_PASSWORD=${{ secrets.MAVEN_PASSWORD }} \
          -PMAVEN_CENTRAL_USERNAME=${{ secrets.MAVEN_CENTRAL_USERNAME }} \
          -PMAVEN_CENTRAL_PASSWORD=${{ secrets.MAVEN_CENTRAL_PASSWORD }}

      - name: Build natives JAR (Windows)
        if: matrix.os == 'windows-2022'
        run: |
          .\gradlew.bat :natives:build :natives:publish `
          --no-daemon `
          -Ptarget=${{ matrix.target }} `
          -PMAVEN_USERNAME=${{ secrets.MAVEN_USERNAME }} `
          -PMAVEN_PASSWORD=${{ secrets.MAVEN_PASSWORD }} `
          -PMAVEN_CENTRAL_USERNAME=${{ secrets.MAVEN_CENTRAL_USERNAME }} `
          -PMAVEN_CENTRAL_PASSWORD=${{ secrets.MAVEN_CENTRAL_PASSWORD }}

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v6
        with:
          name: natives-jar-${{ matrix.target }}
          path: natives/build/libs/natives-*.jar

      - name: Upload debug symbols (Linux)
        if: matrix.os == 'ubuntu-22.04'
        uses: actions/upload-artifact@v6
        with:
          name: natives-symbols-${{ matrix.target }}
          path: natives/cmake-build-${{ matrix.target }}/

      - name: Upload debug symbols (Windows)
        if: matrix.os == 'windows-2022'
        uses: actions/upload-artifact@v6
        with:
          name: natives-symbols-${{ matrix.target }}
          path: natives/cmake-build-${{ matrix.target }}/*.pdb

      - name: Upload debug symbols (macOS)
        if: matrix.os == 'macos-14'
        uses: actions/upload-artifact@v6
        with:
          name: natives-symbols-${{ matrix.target }}
          path: |
            natives/cmake-build-${{ matrix.target }}/libdave-jvm.dylib.dSYM
            natives/cmake-build-${{ matrix.target }}/libdave-jvm.dylib
